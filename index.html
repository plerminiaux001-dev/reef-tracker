<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reef Tank Dashboard & Dosing Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #f4f4f9; --card: #ffffff; --primary: #007bff; --text: #333; --active-tab: #0056b3; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 1000px; margin: 0 auto; }
        h1, h2, h3 { color: #2c3e50; margin-top: 0; }
        
        /* Grid Layouts */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .grid-small { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        
        /* Card Styling */
        .card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card.highlight { border-top: 5px solid var(--primary); }
        
        /* Tab Navigation Styles */
        .tab-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab-btn { background: #e9ecef; color: #555; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; transition: 0.3s; flex: 1; max-width: 200px; text-align: center; }
        .tab-btn:hover { background: #dcdcdc; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        /* Hide tab content by default */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Form Styles */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1em; width: 100%; }
        button:hover { background: #0056b3; }
        button.delete { background: #dc3545; margin-top: 10px; }

        /* Status Indicators */
        .status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .status-box { padding: 10px; border-radius: 5px; text-align: center; color: white; font-weight: bold; }
        .good { background: #28a745; }
        .warn { background: #ffc107; color: #333; }
        .bad { background: #dc3545; }

        /* Calculator Output */
        #calc-results { margin-top: 20px; padding: 15px; background: #e9ecef; border-left: 5px solid #007bff; display: none; }
        .calc-highlight { font-weight: bold; color: #d63384; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }

        /* Instruction Dosing Cards */
        .dose-card { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; text-align: center; }
        .dose-amt { font-size: 1.5em; font-weight: bold; color: var(--primary); margin: 10px 0; }
        .dose-chem { font-size: 0.85em; color: #666; font-style: italic; margin-bottom: 5px; }
        .dose-label { font-weight: bold; color: #2c3e50; }
    </style>
</head>
<body>

    <h1>üê† 389 Reef Command Center</h1>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="openTab('dashboard')">Dashboard</button>
        <button class="tab-btn" onclick="openTab('instructions')">Dosing Instructions</button>
    </div>

    <div id="dashboard" class="tab-content active">
        <div class="card" style="margin-bottom: 20px;">
            <h2>Current Status</h2>
            <div class="status-grid" id="statusDisplay">
                <div class="status-box warn">No Data</div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üìù Add New Log</h2>
                <div class="form-group"><label>Date</label><input type="date" id="date"></div>
                <div class="form-group"><label>Alkalinity (dKH)</label><input type="number" step="0.1" id="alk"></div>
                <div class="form-group"><label>Calcium (ppm)</label><input type="number" id="ca"></div>
                <div class="form-group"><label>Magnesium (ppm)</label><input type="number" id="mg"></div>
                <div class="form-group"><label>Nitrate (ppm)</label><input type="number" step="0.1" id="no3"></div>
                <div class="form-group"><label>Phosphate (ppm)</label><input type="number" step="0.01" id="po4"></div>
                <div class="form-group"><label>pH</label><input type="number" step="0.1" id="ph"></div>
                <button onclick="addLog()">Save Entry</button>
            </div>

            <div class="card">
                <h2>üß™ Dosing Assistant</h2>
                <p>Calculate adjustments for <b>Red Sea Part 1 (Calcium)</b>.</p>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="form-group">
                        <label>Current Ca (ppm)</label>
                        <input type="number" id="calcCurrentCa" placeholder="...">
                    </div>
                    <div class="form-group">
                        <label>Target Ca (ppm)</label>
                        <input type="number" id="calcTargetCa" value="430">
                    </div>
                </div>

                <div class="form-group"><label>Current Daily Dose (mL)</label><input type="number" id="currCaDose" placeholder="e.g. 3.7"></div>
                <div class="form-group"><label>Current NeoNitro Dose (mL)</label><input type="number" id="currNitroDose" placeholder="e.g. 5"></div>
                
                <button onclick="calculateDosing()">Analyze & Adjust</button>
                <div id="calc-results"></div>
            </div>
        </div>

        <div class="card">
            <h2>üìà Trends</h2>
            <canvas id="tankChart"></canvas>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h2>History</h2>
            <button class="delete" onclick="clearData()" style="width: auto; float: right; padding: 5px 10px;">Clear All Data</button>
            <table id="historyTable">
                <thead><tr><th>Date</th><th>Alk</th><th>Ca</th><th>Mg</th><th>NO3</th><th>PO4</th><th>pH</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="instructions" class="tab-content">
        <div class="card highlight">
            <h2>Foundation & Trace Elements</h2>
            <h3>Complete 4-part Supplement Program</h3>
            <p>This is an easy-dose program based on calcium uptake. All four parts are provided in a single pack and will finish at the same time.</p>
            
            <div class="grid-small">
                <div class="dose-card">
                    <div class="dose-label">Reef Care 1</div>
                    <div>Calcium & Magnesium+</div>
                    <div class="dose-chem">Ca | Mg | Sr | Ba</div>
                    <div class="dose-amt">3.7 ml</div>
                    <div>Daily</div>
                </div>

                <div class="dose-card">
                    <div class="dose-label">Reef Care 2</div>
                    <div>KH/Alkalinity & pH</div>
                    <div class="dose-chem">Alkalinity Components</div>
                    <div class="dose-amt">7.5 ml</div>
                    <div>Daily</div>
                </div>

                <div class="dose-card">
                    <div class="dose-label">Reef Care 3</div>
                    <div>Iodine & Potassium+</div>
                    <div class="dose-chem">I‚ÇÇ | Br‚ÇÇ | F‚ÇÇ | K & Trace</div>
                    <div class="dose-amt">1.9 ml</div>
                    <div>Daily</div>
                </div>

                <div class="dose-card">
                    <div class="dose-label">Reef Care 4</div>
                    <div>Iron & Bioactive</div>
                    <div class="dose-chem">Fe + 23 elements</div>
                    <div class="dose-amt">1.9 ml</div>
                    <div>Daily</div>
                </div>
            </div>

            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            <p style="text-align: right; font-weight: bold; color: #555;">Avg. cost for your tank size/month: <span style="color: #28a745;">$10.12</span></p>
        </div>
    </div>

<script>
    // --- TABS LOGIC ---
    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
        const btn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.getAttribute('onclick').includes(tabId));
        if(btn) btn.classList.add('active');
    }

    // --- CONFIGURATION ---
    const TANK_VOL = 35; // gallons
    // Red Sea Math: 1ml raises 100L by 2ppm. 
    // 35g = 132L. 
    // Impact Factor: 1ml raises 132L by approx 1.51 ppm.
    const CA_IMPACT_FACTOR = 1.51; 

    // --- APP LOGIC ---
    let logs = JSON.parse(localStorage.getItem('reefLogs')) || [];
    const dateInput = document.getElementById('date');
    if(dateInput) dateInput.valueAsDate = new Date();

    function saveToStorage() {
        logs.sort((a, b) => new Date(a.date) - new Date(b.date));
        localStorage.setItem('reefLogs', JSON.stringify(logs));
        renderAll();
    }

    function addLog() {
        const entry = {
            date: document.getElementById('date').value,
            alk: parseFloat(document.getElementById('alk').value),
            ca: parseFloat(document.getElementById('ca').value),
            mg: parseFloat(document.getElementById('mg').value),
            no3: parseFloat(document.getElementById('no3').value),
            po4: parseFloat(document.getElementById('po4').value),
            ph: parseFloat(document.getElementById('ph').value)
        };

        if(!entry.date || !entry.alk) { alert("Date and Alkalinity are required!"); return; }
        
        logs.push(entry);
        saveToStorage();
        document.querySelectorAll('input[type=number]').forEach(i => i.value = '');
        // Reset defaults
        document.getElementById('calcTargetCa').value = "430";
    }

    function clearData() {
        if(confirm("Are you sure you want to delete all history?")) {
            localStorage.removeItem('reefLogs');
            logs = [];
            renderAll();
        }
    }

    // --- VISUALIZATION ---
    let chartInstance = null;

    function renderAll() {
        renderTable();
        renderStatus();
        renderChart();
        
        // Auto-populate calc input
        if(logs.length > 0) {
            const last = logs[logs.length - 1];
            if(last.ca) document.getElementById('calcCurrentCa').value = last.ca;
        }
    }

    function renderTable() {
        const tbody = document.querySelector('#historyTable tbody');
        if(!tbody) return;
        tbody.innerHTML = '';
        [...logs].reverse().forEach(log => {
            const row = `<tr>
                <td>${log.date}</td>
                <td>${log.alk}</td>
                <td>${log.ca}</td>
                <td>${log.mg}</td>
                <td>${log.no3}</td>
                <td>${log.po4}</td>
                <td>${log.ph}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function renderStatus() {
        if (logs.length === 0) return;
        const last = logs[logs.length - 1];
        const display = document.getElementById('statusDisplay');
        
        function getStatus(val, min, max) {
            if (val >= min && val <= max) return 'good';
            return 'bad';
        }

        display.innerHTML = `
            <div class="status-box ${getStatus(last.alk, 8, 10)}">Alk: ${last.alk}</div>
            <div class="status-box ${getStatus(last.ca, 400, 450)}">Ca: ${last.ca}</div>
            <div class="status-box ${getStatus(last.no3, 2, 10)}">NO3: ${last.no3}</div>
        `;
    }

    function renderChart() {
        const ctx = document.getElementById('tankChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: logs.map(l => l.date),
                datasets: [
                    { label: 'Alk (dKH)', data: logs.map(l => l.alk), borderColor: '#007bff', tension: 0.1 },
                    { label: 'Calcium (ppm)', data: logs.map(l => l.ca), borderColor: '#6f42c1', tension: 0.1 },
                    { label: 'Nitrate (ppm)', data: logs.map(l => l.no3), borderColor: '#28a745', tension: 0.1 }
                ]
            }
        });
    }

    // --- DOSING CALCULATOR LOGIC (Target Based) ---
    function calculateDosing() {
        // Inputs
        const currentCa = parseFloat(document.getElementById('calcCurrentCa').value);
        const targetCa = parseFloat(document.getElementById('calcTargetCa').value);
        const currCaDose = parseFloat(document.getElementById('currCaDose').value) || 0;
        const currNitroDose = parseFloat(document.getElementById('currNitroDose').value) || 0;

        if (!currentCa || !targetCa) { alert("Please enter Current and Target Calcium."); return; }
        
        // 1. Calculate Trend (Consumption) from Logs
        // We need logs to know if the tank is consuming more or less than the current dose provides.
        let consumptionMsg = "";
        let suggestedDailyDose = currCaDose;
        
        if (logs.length >= 2) {
            const currentLog = logs[logs.length - 1];
            const prevLog = logs[logs.length - 2];
            const daysDiff = (new Date(currentLog.date) - new Date(prevLog.date)) / (1000 * 60 * 60 * 24);

            if (daysDiff > 0 && currentLog.ca && prevLog.ca) {
                const caChange = currentLog.ca - prevLog.ca; // e.g. -10 (dropped) or +5 (rose)
                const dailyChange = caChange / daysDiff; // e.g. -5 ppm per day
                
                // If dailyChange is negative, we are under-dosing.
                // If positive, we are over-dosing.
                // How many mL represents that change?
                const mlAdjustment = Math.abs(dailyChange) / CA_IMPACT_FACTOR;

                if (dailyChange < -2) {
                    suggestedDailyDose += mlAdjustment;
                    consumptionMsg = `üìâ Tank is consuming calcium faster than you are dosing.<br><b>Increase Daily Dose to: ${suggestedDailyDose.toFixed(1)} mL</b>`;
                } else if (dailyChange > 2) {
                    suggestedDailyDose -= mlAdjustment;
                    if(suggestedDailyDose < 0) suggestedDailyDose = 0;
                    consumptionMsg = `üìà Calcium is accumulating.<br><b>Reduce Daily Dose to: ${suggestedDailyDose.toFixed(1)} mL</b>`;
                } else {
                    consumptionMsg = `‚úÖ Daily consumption is stable. Keep dosing <b>${currCaDose} mL/day</b>.`;
                }
            } else {
                consumptionMsg = "‚ö†Ô∏è Not enough history to calculate consumption trend.";
            }
        } else {
            consumptionMsg = "‚ö†Ô∏è Need 2+ logs to calculate daily consumption.";
        }

        // 2. Calculate Correction (Gap to Target)
        // This is purely: "I am at X, I want to be at Y"
        const gap = targetCa - currentCa;
        let correctionMsg = "";
        
        if (Math.abs(gap) > 5) {
            const correctionMl = gap / CA_IMPACT_FACTOR;
            if (gap > 0) {
                correctionMsg = `üëâ <b>One-Time Correction:</b> Add <span class="calc-highlight">${correctionMl.toFixed(1)} mL</span> of Part 1 to reach ${targetCa}.`;
                if (gap > 20) {
                    correctionMsg += `<br><small style="color:red;">‚ö†Ô∏è Large increase! Split this dose over 2 days.</small>`;
                }
            } else {
                correctionMsg = `üëâ <b>One-Time Correction:</b> Skip dosing for a day or two until levels drop to ${targetCa}.`;
            }
        } else {
            correctionMsg = `‚úÖ You are at your target level.`;
        }

        // 3. Nitrate Logic
        let no3Msg = "";
        if (logs.length >= 2) {
             const curL = logs[logs.length-1];
             const preL = logs[logs.length-2];
             const d = curL.no3 - preL.no3;
             if(d > 2) no3Msg = "Nitrates rising fast. Cut NeoNitro 50%.";
             else if(d < -1) no3Msg = "Nitrates falling. Increase food/Nitro.";
             else no3Msg = "Nitrates stable.";
        }

        // Output
        const resDiv = document.getElementById('calc-results');
        resDiv.style.display = 'block';
        resDiv.innerHTML = `
            <h3>Dosing Plan</h3>
            <p>${consumptionMsg}</p>
            <hr>
            <p>${correctionMsg}</p>
            <p style="font-size:0.9em; background:#fff3cd; padding:5px; border-radius:4px;">
                <b>Note:</b> If changing Part 1 (Calcium) dose, remember to adjust Parts 2, 3, & 4 proportionally to maintain Red Sea ratios.
            </p>
            <hr>
            <p><b>Nitrate Status:</b> ${no3Msg}</p>
        `;
    }

    // Initialize
    renderAll();
</script>
</body>
</html>
