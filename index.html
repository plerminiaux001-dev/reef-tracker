<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reef Tank Dashboard & Dosing Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #f4f4f9; --card: #ffffff; --primary: #007bff; --text: #333; --active-tab: #0056b3; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 1000px; margin: 0 auto; }
        h1, h2, h3 { color: #2c3e50; margin-top: 0; }
        
        /* Grid Layouts */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .grid-small { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        
        /* Card Styling */
        .card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card.highlight { border-top: 5px solid var(--primary); }
        
        /* Tab Navigation Styles */
        .tab-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab-btn { background: #e9ecef; color: #555; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; transition: 0.3s; flex: 1; max-width: 200px; text-align: center; }
        .tab-btn:hover { background: #dcdcdc; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        /* Hide tab content by default */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Form Styles */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1em; width: 100%; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* Status Indicators */
        .status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .status-box { padding: 10px; border-radius: 5px; text-align: center; color: white; font-weight: bold; }
        .good { background: #28a745; }
        .warn { background: #ffc107; color: #333; }
        .bad { background: #dc3545; }

        /* Calculator Output */
        #calc-results { margin-top: 20px; padding: 15px; background: #e9ecef; border-left: 5px solid #007bff; display: none; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        
        /* Info Tables (Instructions Tab) */
        .info-table { width: 100%; border: 1px solid #eee; margin-bottom: 20px; font-size: 0.9em; }
        .info-table th { background: #007bff; color: white; text-align: center; }
        .info-table td { text-align: center; border-bottom: 1px solid #eee; }
        .info-table tr:last-child td { border-bottom: none; }
    </style>
</head>
<body>

    <h1>üê† 389 Reef Command Center</h1>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="openTab('dashboard')">Dashboard</button>
        <button class="tab-btn" onclick="openTab('instructions')">Dosing Instructions</button>
    </div>

    <div id="dashboard" class="tab-content active">
        <div class="card" style="margin-bottom: 20px;">
            <h2>Current Status</h2>
            <div class="status-grid" id="statusDisplay">
                <div class="status-box warn">Loading Cloud Data...</div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üìù Add New Log</h2>
                <div class="form-group"><label>Date</label><input type="date" id="date"></div>
                <div class="form-group"><label>Alkalinity (dKH)</label><input type="number" step="0.1" id="alk"></div>
                <div class="form-group"><label>Calcium (ppm)</label><input type="number" id="ca"></div>
                <div class="form-group"><label>Magnesium (ppm)</label><input type="number" id="mg"></div>
                <div class="form-group"><label>Nitrate (ppm)</label><input type="number" step="0.1" id="no3"></div>
                <div class="form-group"><label>Phosphate (ppm)</label><input type="number" step="0.01" id="po4"></div>
                <div class="form-group"><label>pH</label><input type="number" step="0.1" id="ph"></div>
                <button onclick="addLog()">Save Entry</button>
            </div>

            <div class="card">
                <h2>üß™ Dosing Assistant</h2>
                <p>Calculate your daily Red Sea recipe based on Calcium uptake.</p>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                    <div class="form-group">
                        <label>Current Ca (ppm)</label>
                        <input type="number" id="calcCurrentCa" placeholder="...">
                    </div>
                    <div class="form-group">
                        <label>Target Ca (ppm)</label>
                        <input type="number" id="calcTargetCa" value="430">
                    </div>
                </div>

                <button onclick="calculateDosing()">Calculate Recipe</button>
                <div id="calc-results"></div>
            </div>
        </div>

        <div class="card">
            <h2>üìà Trends</h2>
            <canvas id="tankChart"></canvas>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h2>History (Google Sheets)</h2>
            <button onclick="loadData()" style="width: auto; float: right; padding: 5px 10px; background: #6c757d; color:white; border:none; border-radius:3px; cursor:pointer;">‚Üª Refresh</button>
            <table id="historyTable">
                <thead><tr><th>Date</th><th>Alk</th><th>Ca</th><th>Mg</th><th>NO3</th><th>PO4</th><th>pH</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="instructions" class="tab-content">
        <div class="card highlight" style="margin-bottom: 20px; border-top-color: #6f42c1;">
            <h2>ü§ñ Hydros Blenny Configuration</h2>
            <p>Setup guide for the 4-head doser using Red Sea Complete Reef Care.</p>

            <h3>1. Pump Mapping & Tubing</h3>
            <div class="grid-small">
                <div class="status-box" style="background:#6f42c1;">
                    Doser 1<br><strong>Part 1 (Ca+)</strong><br><small>Master Dose</small>
                </div>
                <div class="status-box" style="background:#007bff;">
                    Doser 2<br><strong>Part 2 (Alk)</strong><br><small>2x Multiplier</small>
                </div>
                <div class="status-box" style="background:#20c997;">
                    Doser 3<br><strong>Part 3 (Iodine)</strong><br><small>0.5x Multiplier</small>
                </div>
                <div class="status-box" style="background:#ffc107; color:#333;">
                    Doser 4<br><strong>Part 4 (Bio)</strong><br><small>0.5x Multiplier</small>
                </div>
            </div>

            <h3>2. Hydros App Settings</h3>
            <table class="info-table">
                <thead>
                    <tr><th>Setting</th><th>Value</th><th>Notes</th></tr>
                </thead>
                <tbody>
                    <tr><td>Output Type</td><td>Dosing Pump</td><td>Create 4 separate outputs.</td></tr>
                    <tr><td>Dosing Mode</td><td>Schedule (Simple)</td><td>Spreads dose over 24h.</td></tr>
                    <tr><td>Flow Rate</td><td><em>Calibrate!</em></td><td>Run calibration for each head.</td></tr>
                    <tr><td>Safe Range</td><td>On</td><td>Set max daily limit (e.g. 50ml).</td></tr>
                </tbody>
            </table>

            <h3>3. Schedule Offsets (Precipitation Prevention)</h3>
            <p style="font-size:0.9em; color:#666;">Do not dose Ca and Alk at the exact same moment.</p>
            <table class="info-table">
                <thead>
                    <tr><th>Pump</th><th>Start Time</th><th>Dosage Formula</th></tr>
                </thead>
                <tbody>
                    <tr><td><strong>Doser 1</strong> (Ca)</td><td>00:00</td><td>Base Amount (From Calculator)</td></tr>
                    <tr><td><strong>Doser 2</strong> (Alk)</td><td>00:30</td><td>2.0 x [Doser 1]</td></tr>
                    <tr><td><strong>Doser 3</strong> (Trace)</td><td>01:00</td><td>0.5 x [Doser 1]</td></tr>
                    <tr><td><strong>Doser 4</strong> (Trace)</td><td>01:30</td><td>0.5 x [Doser 1]</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>üìö Red Sea Complete Reef Care</h2>
            <p>A 4-part program based on Calcium uptake. All 4 parts are dosed in a fixed ratio.</p>

            <h3>1. Recommended Parameters</h3>
            <table class="info-table">
                <thead>
                    <tr><th>Type</th><th>Salinity</th><th>Calcium</th><th>Alkalinity</th></tr>
                </thead>
                <tbody>
                    <tr><td>Mixed Reef</td><td>34 ppt</td><td>450 ppm</td><td>11.5 dKH</td></tr>
                    <tr><td>SPS Dominant</td><td>35 ppt</td><td>430 ppm</td><td>8.0 dKH</td></tr>
                    <tr><td>ULNS / Low Nutrients</td><td>33 ppt</td><td>410 ppm</td><td>7.0 dKH</td></tr>
                </tbody>
            </table>

            <h3>2. Dosing Ratios</h3>
            <p style="font-size:0.9em; color:#666;">The system uses Part 1 (Calcium) as the master dose. All other parts are calculated relative to it.</p>
            <table class="info-table">
                <thead>
                    <tr><th>Supplement</th><th>Ratio</th><th>Dose per 1mL of Part 1</th></tr>
                </thead>
                <tbody>
                    <tr><td><b>Part 1</b> (Ca & Mg)</td><td>1.0</td><td>1 mL</td></tr>
                    <tr><td><b>Part 2</b> (Alk & pH)</td><td>2.0</td><td>2 mL</td></tr>
                    <tr><td><b>Part 3</b> (Iodine & K)</td><td>0.5</td><td>0.5 mL</td></tr>
                    <tr><td><b>Part 4</b> (Iron & Bio)</td><td>0.5</td><td>0.5 mL</td></tr>
                </tbody>
            </table>
        </div>
    </div>

<script>
    // --- ‚¨áÔ∏è CONFIGURATION AREA ‚¨áÔ∏è ---
    
    // YOUR GOOGLE SHEETS API URL
    const API_URL = "https://script.google.com/macros/s/AKfycbx3kGuD6DuZDGs7FJmbMtwLEQBWMsLwUV_BGLwknEhQanE-r2-dOphooa6_pP1U0dEo/exec"; 

    const TANK_GAL = 35; 
    const TANK_LITERS = TANK_GAL * 3.78541;
    const CA_IMPACT_PER_100L = 1.4; 
    const CA_IMPACT_FACTOR = CA_IMPACT_PER_100L * (100 / TANK_LITERS); 

    const RATIO_P2 = 2.0;
    const RATIO_P3 = 0.5;
    const RATIO_P4 = 0.5;

    // --- END CONFIGURATION ---

    let logs = [];

    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        const btn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.getAttribute('onclick').includes(tabId));
        if(btn) btn.classList.add('active');
    }

    const dateInput = document.getElementById('date');
    if(dateInput) dateInput.valueAsDate = new Date();

    // --- GOOGLE SHEETS CONNECTION ---
    async function loadData() {
        const display = document.getElementById('statusDisplay');
        // Reset status only if it's the first load or manual refresh
        if(logs.length === 0) display.innerHTML = '<div class="status-box warn">Loading...</div>';
        
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            
            logs = data.map(item => ({
                date: item.date.toString().split('T')[0],
                alk: parseFloat(item.alk),
                ca: parseFloat(item.ca),
                mg: parseFloat(item.mg),
                no3: parseFloat(item.no3),
                po4: parseFloat(item.po4),
                ph: parseFloat(item.ph)
            }));

            // Sort newest last for internal processing
            logs.sort((a, b) => new Date(a.date) - new Date(b.date));
            renderAll();
        } catch (error) {
            console.error(error);
            display.innerHTML = '<div class="status-box bad">Connection Failed</div>';
        }
    }

    function addLog() {
        const btn = document.querySelector('button[onclick="addLog()"]');
        const originalText = btn.innerText;
        btn.innerText = "Saving...";
        btn.disabled = true;

        const entry = {
            date: document.getElementById('date').value,
            alk: document.getElementById('alk').value,
            ca: document.getElementById('ca').value,
            mg: document.getElementById('mg').value,
            no3: document.getElementById('no3').value,
            po4: document.getElementById('po4').value,
            ph: document.getElementById('ph').value
        };

        if(!entry.date || !entry.alk) { 
            alert("Date and Alkalinity are required!"); 
            btn.innerText = originalText; 
            btn.disabled = false;
            return; 
        }

        fetch(API_URL, {
            method: "POST",
            mode: "no-cors", 
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(entry)
        }).then(() => {
            alert("Saved to Cloud!");
            // Optimistic update
            logs.push({
                date: entry.date,
                alk: parseFloat(entry.alk),
                ca: parseFloat(entry.ca),
                mg: parseFloat(entry.mg),
                no3: parseFloat(entry.no3),
                po4: parseFloat(entry.po4),
                ph: parseFloat(entry.ph)
            });
            renderAll();
            document.querySelectorAll('input[type=number]').forEach(i => i.value = '');
            btn.innerText = originalText;
            btn.disabled = false;
        }).catch(err => {
            alert("Error: " + err);
            btn.innerText = originalText;
            btn.disabled = false;
        });
    }

    // --- VISUALIZATION ---
    let chartInstance = null;

    function renderAll() {
        renderTable();
        renderStatus();
        renderChart();
        if(logs.length > 0) {
            const last = logs[logs.length - 1];
            if(last.ca) document.getElementById('calcCurrentCa').value = last.ca;
        }
    }

    function renderTable() {
        const tbody = document.querySelector('#historyTable tbody');
        if(!tbody) return;
        tbody.innerHTML = '';
        [...logs].reverse().forEach(log => {
            const row = `<tr>
                <td>${log.date}</td>
                <td>${log.alk || '-'}</td>
                <td>${log.ca || '-'}</td>
                <td>${log.mg || '-'}</td>
                <td>${log.no3 || '-'}</td>
                <td>${log.po4 || '-'}</td>
                <td>${log.ph || '-'}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function renderStatus() {
        if (logs.length === 0) {
            document.getElementById('statusDisplay').innerHTML = '<div class="status-box warn">No Data</div>';
            return;
        }
        const last = logs[logs.length - 1];
        const display = document.getElementById('statusDisplay');
        function getStatus(val, min, max) { return (val >= min && val <= max) ? 'good' : 'bad'; }

        display.innerHTML = `
            <div class="status-box ${getStatus(last.alk, 8, 10)}">Alk: ${last.alk || '?'}</div>
            <div class="status-box ${getStatus(last.ca, 400, 450)}">Ca: ${last.ca || '?'}</div>
            <div class="status-box ${getStatus(last.no3, 2, 10)}">NO3: ${last.no3 || '?'}</div>
        `;
    }

    function renderChart() {
        const ctx = document.getElementById('tankChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        
        // Filter datasets to avoid zero-drops
        const hasAlk = logs.some(l => l.alk);
        const hasCa = logs.some(l => l.ca);
        const hasNo3 = logs.some(l => l.no3);

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: logs.map(l => l.date),
                datasets: [
                    { label: 'Alk', data: logs.map(l => l.alk), borderColor: '#007bff', spanGaps: true, hidden: !hasAlk },
                    { label: 'Calcium', data: logs.map(l => l.ca), borderColor: '#6f42c1', spanGaps: true, hidden: !hasCa },
                    { label: 'Nitrate', data: logs.map(l => l.no3), borderColor: '#28a745', spanGaps: true, hidden: !hasNo3 }
                ]
            }
        });
    }

    // --- CALCULATOR LOGIC ---
    function calculateDosing() {
        const currentCa = parseFloat(document.getElementById('calcCurrentCa').value);
        const targetCa = parseFloat(document.getElementById('calcTargetCa').value);

        if (!currentCa || !targetCa) { alert("Please enter Current and Target Calcium."); return; }
        
        let dailyP1 = 0;
        let dailyDrop = 0;
        
        const caLogs = logs.filter(l => l.ca);
        if (caLogs.length >= 2) {
            const curL = caLogs[caLogs.length-1];
            const preL = caLogs[caLogs.length-2];
            const days = (new Date(curL.date) - new Date(preL.date)) / (1000*60*60*24);
            
            if(days > 0) {
                const caLoss = preL.ca - curL.ca; 
                dailyDrop = caLoss / days;
                if (dailyDrop > 0) dailyP1 = dailyDrop / CA_IMPACT_FACTOR;
            }
        }

        const dailyP2 = dailyP1 * RATIO_P2;
        const dailyP3 = dailyP1 * RATIO_P3;
        const dailyP4 = dailyP1 * RATIO_P4;

        const gap = targetCa - currentCa;
        let correctionP1_Daily = 0;
        let correctionMsg = "‚úÖ Levels match target.";

        if (gap > 5) {
            const totalCorrectionNeeded = gap / CA_IMPACT_FACTOR;
            if (gap > 20) {
                correctionP1_Daily = totalCorrectionNeeded / 3;
                correctionMsg = `‚ö†Ô∏è <b>Low Calcium (-${gap} ppm).</b><br>Adding correction dose over 3 days.`;
            } else {
                correctionP1_Daily = totalCorrectionNeeded;
                correctionMsg = `‚ö†Ô∏è <b>Low Calcium (-${gap} ppm).</b><br>Adding correction dose today.`;
            }
        }

        const totalP1Today = dailyP1 + correctionP1_Daily;

        const resDiv = document.getElementById('calc-results');
        resDiv.style.display = 'block';
        resDiv.innerHTML = `
            <h3>üß™ Red Sea Dosing Plan</h3>
            <p>Daily Consumption: <b>${dailyDrop.toFixed(1)} ppm/day</b></p>
            <table style="width:100%; border-collapse: collapse; text-align: center; border:1px solid #ddd;">
                <tr style="background:#f0f0f0; font-weight:bold;">
                    <td style="padding:8px;">Product</td>
                    <td style="padding:8px;">Base</td>
                    <td style="padding:8px; color:#d63384;">Corr.</td>
                    <td style="padding:8px; background:#e3f2fd;">TOTAL</td>
                </tr>
                <tr>
                    <td style="text-align:left; padding:8px;"><b>Part 1</b> (Ca)</td>
                    <td>${dailyP1.toFixed(1)}</td>
                    <td style="color:#d63384;">+ ${correctionP1_Daily.toFixed(1)}</td>
                    <td style="background:#e3f2fd; font-weight:bold;">${totalP1Today.toFixed(1)} mL</td>
                </tr>
                <tr>
                    <td style="text-align:left; padding:8px;"><b>Part 2</b> (Alk)</td>
                    <td>${dailyP2.toFixed(1)}</td>
                    <td>-</td>
                    <td style="background:#e3f2fd;">${dailyP2.toFixed(1)} mL</td>
                </tr>
                <tr>
                    <td style="text-align:left; padding:8px;"><b>Part 3</b> (Iodine)</td>
                    <td>${dailyP3.toFixed(1)}</td>
                    <td>-</td>
                    <td style="background:#e3f2fd;">${dailyP3.toFixed(1)} mL</td>
                </tr>
                <tr>
                    <td style="text-align:left; padding:8px;"><b>Part 4</b> (Bio)</td>
                    <td>${dailyP4.toFixed(1)}</td>
                    <td>-</td>
                    <td style="background:#e3f2fd;">${dailyP4.toFixed(1)} mL</td>
                </tr>
            </table>
            <p style="margin-top:10px; font-size:0.9em; color:#666;"><em>${correctionMsg}</em></p>
        `;
    }

    loadData();
</script>
</body>
</html>
