<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Reef Tank Dashboard & Dosing Calculator</title>

    <style>
        :root { --bg: #f4f4f9; --card: #ffffff; --primary: #007bff; --text: #333; --active-tab: #0056b3; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 1000px; margin: 0 auto; }
        h1, h2, h3 { color: #2c3e50; margin-top: 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .grid-small { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card.highlight { border-top: 5px solid var(--primary); }
        .tab-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab-btn { background: #e9ecef; color: #555; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; transition: 0.3s; flex: 1; max-width: 200px; }
        .tab-btn:hover { background: #dcdcdc; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1em; width: 100%; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .status-box { padding: 10px; border-radius: 5px; text-align: center; color: white; font-weight: bold; }
        .good { background: #28a745; }
        .warn { background: #ffc107; color:#333; }
        .bad { background: #dc3545; }
        #calc-results { margin-top: 20px; padding: 15px; background: #e9ecef; border-left: 5px solid #007bff; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        .info-table { width: 100%; border: 1px solid #eee; margin-bottom: 20px; font-size: 0.9em; }
        .info-table th { background: #007bff; color: white; text-align: center; }
        .info-table td { text-align: center; border-bottom: 1px solid #eee; }
        .info-table tr:last-child td { border-bottom: none; }
        
        /* Chart specific styles */
        .chart-container { position: relative; height: 350px; width: 100%; }
        .chart-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .chart-check-label { display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer; padding: 4px 8px; border-radius: 4px; background: #f8f9fa; }
        .chart-check-label:hover { background: #e9ecef; }
        .chart-check-label input { width: auto; margin: 0; }
    </style>
</head>
<body>

    <h1>üê† 389 Reef Command Center</h1>

    <div class="tab-nav">
        <button class="tab-btn active" data-target="dashboard">Dashboard</button>
        <button class="tab-btn" data-target="instructions">Dosing Instructions</button>
    </div>

    <div id="dashboard" class="tab-content active">
        <div class="card" style="margin-bottom: 20px;">
            <h2>Current Status</h2>
            <div class="status-grid" id="statusDisplay">
                <div class="status-box warn">Loading Cloud Data...</div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üìù Add New Log</h2>
                <div class="form-group"><label for="date">Date</label><input type="date" id="date"></div>
                <div class="form-group"><label for="alk">Alkalinity (dKH)</label><input type="number" step="0.1" id="alk"></div>
                <div class="form-group"><label for="ca">Calcium (ppm)</label><input type="number" id="ca"></div>
                <div class="form-group"><label for="mg">Magnesium (ppm)</label><input type="number" id="mg"></div>
                <div class="form-group"><label for="no3">Nitrate (ppm)</label><input type="number" step="0.1" id="no3"></div>
                <div class="form-group"><label for="po4">Phosphate (ppm)</label><input type="number" step="0.01" id="po4"></div>
                <div class="form-group"><label for="ph">pH</label><input type="number" step="0.1" id="ph"></div>
                <button id="saveEntryBtn">Save Entry</button>
            </div>

            <div class="card">
                <h2>üß™ Dosing Assistant</h2>
                <p>Calculate your daily Red Sea recipe based on Calcium uptake.</p>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                    <div class="form-group">
                        <label for="calcCurrentCa">Current Ca (ppm)</label>
                        <input type="number" id="calcCurrentCa" placeholder="...">
                    </div>
                    <div class="form-group">
                        <label for="calcTargetCa">Target Ca (ppm)</label>
                        <input type="number" id="calcTargetCa" value="430">
                    </div>
                </div>

                <button id="calcBtn">Calculate Recipe</button>
                <div id="calc-results" aria-live="polite"></div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="margin:0;">üìà Trends</h2>
            </div>
            
            <div class="chart-controls">
                <label class="chart-check-label"><input type="checkbox" data-idx="0" checked> üîµ Alk</label>
                <label class="chart-check-label"><input type="checkbox" data-idx="1" checked> üü£ Ca</label>
                <label class="chart-check-label"><input type="checkbox" data-idx="2"> üü† Mg</label>
                <label class="chart-check-label"><input type="checkbox" data-idx="3" checked> üü¢ NO3</label>
                <label class="chart-check-label"><input type="checkbox" data-idx="4"> üü§ PO4</label>
                <label class="chart-check-label"><input type="checkbox" data-idx="5"> üî¥ pH</label>
            </div>

            <div class="chart-container">
                <canvas id="tankChart"></canvas>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h2>History (Google Sheets)</h2>
            <button id="refreshBtn" style="width: auto; float: right; padding: 5px 10px; background: #6c757d; color:white; border:none; border-radius:3px; cursor:pointer;">‚Üª Refresh</button>
            <table id="historyTable">
                <thead><tr><th>Date</th><th>Alk</th><th>Ca</th><th>Mg</th><th>NO3</th><th>PO4</th><th>pH</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="instructions" class="tab-content" aria-hidden="true">
        <div class="card highlight" style="margin-bottom: 20px; border-top-color: #6f42c1;">
            <h2>ü§ñ Hydros Blenny Configuration</h2>
            <p>Setup guide for the 4-head doser using Red Sea Complete Reef Care.</p>
            <h3>1. Pump Mapping & Tubing</h3>
            <div class="grid-small">
                <div class="status-box" style="background:#6f42c1;">
                    Doser 1<br><strong>Part 1 (Ca+)</strong><br><small>Master Dose</small>
                </div>
                <div class="status-box" style="background:#007bff;">
                    Doser 2<br><strong>Part 2 (Alk)</strong><br><small>2x Multiplier</small>
                </div>
                <div class="status-box" style="background:#20c997;">
                    Doser 3<br><strong>Part 3 (Iodine)</strong><br><small>0.5x Multiplier</small>
                </div>
                <div class="status-box" style="background:#ffc107; color:#333;">
                    Doser 4<br><strong>Part 4 (Bio)</strong><br><small>0.5x Multiplier</small>
                </div>
            </div>
            <h3>2. Hydros App Settings</h3>
            <table class="info-table">
                <thead>
                    <tr><th>Setting</th><th>Value</th><th>Notes</th></tr>
                </thead>
                <tbody>
                    <tr><td>Output Type</td><td>Dosing Pump</td><td>Create 4 separate outputs.</td></tr>
                    <tr><td>Dosing Mode</td><td>Schedule (Simple)</td><td>Spreads dose over 24h.</td></tr>
                    <tr><td>Flow Rate</td><td><em>Calibrate!</em></td><td>Run calibration for each head.</td></tr>
                    <tr><td>Safe Range</td><td>On</td><td>Set max daily limit (e.g. 50ml).</td></tr>
                </tbody>
            </table>
            <h3>3. Schedule Offsets (Precipitation Prevention)</h3>
            <p style="font-size:0.9em; color:#666;">Do not dose Ca and Alk at the exact same moment.</p>
            <table class="info-table">
                <thead>
                    <tr><th>Pump</th><th>Start Time</th><th>Dosage Formula</th></tr>
                </thead>
                <tbody>
                    <tr><td><strong>Doser 1</strong> (Ca)</td><td>00:00</td><td>Base Amount (From Calculator)</td></tr>
                    <tr><td><strong>Doser 2</strong> (Alk)</td><td>00:30</td><td>2.0 x [Doser 1]</td></tr>
                    <tr><td><strong>Doser 3</strong> (Trace)</td><td>01:00</td><td>0.5 x [Doser 1]</td></tr>
                    <tr><td><strong>Doser 4</strong> (Trace)</td><td>01:30</td><td>0.5 x [Doser 1]</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>üìö Red Sea Complete Reef Care</h2>
            <p>A 4-part program based on Calcium uptake. All 4 parts are dosed in a fixed ratio.</p>
            <h3>1. Recommended Parameters</h3>
            <table class="info-table">
                <thead>
                    <tr><th>Type</th><th>Salinity</th><th>Calcium</th><th>Alkalinity</th></tr>
                </thead>
                <tbody>
                    <tr><td>Mixed Reef</td><td>34 ppt</td><td>450 ppm</td><td>11.5 dKH</td></tr>
                    <tr><td>SPS Dominant</td><td>35 ppt</td><td>430 ppm</td><td>8.0 dKH</td></tr>
                    <tr><td>ULNS / Low Nutrients</td><td>33 ppt</td><td>410 ppm</td><td>7.0 dKH</td></tr>
                </tbody>
            </table>
            <h3>2. Dosing Ratios</h3>
            <p style="font-size:0.9em; color:#666;">The system uses Part 1 (Calcium) as the master dose. All other parts are calculated relative to it.</p>
            <table class="info-table">
                <thead>
                    <tr><th>Supplement</th><th>Ratio</th><th>Dose per 1mL of Part 1</th></tr>
                </thead>
                <tbody>
                    <tr><td><b>Part 1</b> (Ca & Mg)</td><td>1.0</td><td>1 mL</td></tr>
                    <tr><td><b>Part 2</b> (Alk & pH)</td><td>2.0</td><td>2 mL</td></tr>
                    <tr><td><b>Part 3</b> (Iodine & K)</td><td>0.5</td><td>0.5 mL</td></tr>
                    <tr><td><b>Part 4</b> (Iron & Bio)</td><td>0.5</td><td>0.5 mL</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
    // --- ‚¨áÔ∏è CONFIGURATION AREA ‚¨áÔ∏è ---
    const API_URL = "https://script.google.com/macros/s/AKfycbx3kGuD6DuZDGs7FJmbMtwLEQBWMsLwUV_BGLwknEhQanE-r2-dOphooa6_pP1U0dEo/exec";
    const TANK_GAL = 35;
    const TANK_LITERS = TANK_GAL * 3.78541;
    const CA_IMPACT_PER_100L = 1.4; // ppm per 100L per mL
    const CA_IMPACT_FACTOR = CA_IMPACT_PER_100L * (100 / TANK_LITERS); // ppm per mL for this tank
    const RATIO_P2 = 2.0;
    const RATIO_P3 = 0.5;
    const RATIO_P4 = 0.5;
    // --- END CONFIGURATION ---

    let logs = [];
    let chartInstance = null;

    // Cached elements
    const statusDisplay = document.getElementById('statusDisplay');
    const historyTbody = document.querySelector('#historyTable tbody');
    const saveEntryBtn = document.getElementById('saveEntryBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const calcBtn = document.getElementById('calcBtn');
    const calcResults = document.getElementById('calc-results');
    const dateInput = document.getElementById('date');
    const calcCurrentCaInput = document.getElementById('calcCurrentCa');
    const calcTargetCaInput = document.getElementById('calcTargetCa');
    const tankCtx = document.getElementById('tankChart').getContext('2d');
    const chartCheckboxes = document.querySelectorAll('.chart-check-label input');

    // Helper: safely parse number
    const toNum = v => {
        const n = parseFloat(v);
        return Number.isFinite(n) ? n : null;
    };

    // Tab navigation
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const id = btn.dataset.target;
            const target = document.getElementById(id);
            if(target) {
                target.classList.add('active');
                btn.classList.add('active');
            }
        });
    });

    // Init date field
    if (dateInput) dateInput.valueAsDate = new Date();

    // Event listeners
    saveEntryBtn.addEventListener('click', submitLog);
    refreshBtn.addEventListener('click', () => loadData(true));
    calcBtn.addEventListener('click', calculateDosing);
    
    // Checkbox listener for graph
    chartCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            if(chartInstance) {
                const idx = parseInt(cb.dataset.idx);
                const isChecked = cb.checked;
                // Toggle dataset visibility
                chartInstance.data.datasets[idx].hidden = !isChecked;
                chartInstance.update();
            }
        });
    });

    // Fetch data from Google Sheets / Apps Script
    async function loadData(forceRefresh = false) {
        if (!statusDisplay) return;
        if (logs.length === 0 || forceRefresh) {
            statusDisplay.innerHTML = '<div class="status-box warn">Loading...</div>';
        }
        try {
            const resp = await fetch(API_URL);
            if (!resp.ok) throw new Error('Network response was not ok: ' + resp.status);
            const data = await resp.json();

            // Map + validate
            logs = data.map(item => ({
                date: (item.date || '').toString().split('T')[0],
                alk: toNum(item.alk),
                ca: toNum(item.ca),
                mg: toNum(item.mg),
                no3: toNum(item.no3),
                po4: toNum(item.po4),
                ph: toNum(item.ph)
            })).filter(Boolean);

            logs.sort((a,b) => new Date(a.date) - new Date(b.date));
            renderAll();
        } catch (err) {
            console.error('loadData error', err);
            statusDisplay.innerHTML = '<div class="status-box bad">Connection Failed</div>';
        }
    }

    // Submit new log
    async function submitLog() {
        const btn = saveEntryBtn;
        const originalText = btn.innerText;
        btn.innerText = "Saving...";
        btn.disabled = true;

        const entry = {
            date: (dateInput.value || '').trim(),
            alk: document.getElementById('alk').value.trim(),
            ca: document.getElementById('ca').value.trim(),
            mg: document.getElementById('mg').value.trim(),
            no3: document.getElementById('no3').value.trim(),
            po4: document.getElementById('po4').value.trim(),
            ph: document.getElementById('ph').value.trim()
        };

        if (!entry.date || !entry.alk) {
            alert("Date and Alkalinity are required!");
            btn.innerText = originalText;
            btn.disabled = false;
            return;
        }

        try {
            const resp = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(entry)
            });
            if (!resp.ok) throw new Error('Server returned ' + resp.status);
            try { await resp.json(); } catch (e) { }

            alert("Saved to Cloud!");
        } catch (err) {
            console.warn('POST failed, attempting no-cors fallback', err);
            try {
                await fetch(API_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(entry)
                });
                alert("Saved to Cloud (fallback).");
            } catch (err2) {
                alert("Error saving: " + err2);
                btn.innerText = originalText;
                btn.disabled = false;
                return;
            }
        }

        // Optimistic UI update
        logs.push({
            date: entry.date,
            alk: toNum(entry.alk),
            ca: toNum(entry.ca),
            mg: toNum(entry.mg),
            no3: toNum(entry.no3),
            po4: toNum(entry.po4),
            ph: toNum(entry.ph)
        });
        renderAll();

        document.querySelectorAll('input[type=number]').forEach(i => i.value = '');
        btn.innerText = originalText;
        btn.disabled = false;
    }

    function renderAll() {
        renderTable();
        renderStatus();
        renderChart();
        if (logs.length > 0 && calcCurrentCaInput) {
            const last = logs[logs.length - 1];
            if (last && toNum(last.ca) !== null) calcCurrentCaInput.value = last.ca;
        }
    }

    function renderTable() {
        if (!historyTbody) return;
        const frag = document.createDocumentFragment();
        [...logs].slice().reverse().forEach(log => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${log.date || '-'}</td>
                <td>${log.alk ?? '-'}</td>
                <td>${log.ca ?? '-'}</td>
                <td>${log.mg ?? '-'}</td>
                <td>${log.no3 ?? '-'}</td>
                <td>${log.po4 ?? '-'}</td>
                <td>${log.ph ?? '-'}</td>
            `;
            frag.appendChild(tr);
        });
        historyTbody.innerHTML = '';
        historyTbody.appendChild(frag);
    }

    function renderStatus() {
        if (!statusDisplay) return;
        if (logs.length === 0) {
            statusDisplay.innerHTML = '<div class="status-box warn">No Data</div>';
            return;
        }
        const last = logs[logs.length-1];

        const getStatus = (val, min, max) => {
            if (val === null || val === undefined) return 'warn';
            if (val >= min && val <= max) return 'good';
            if (val < min) return 'warn';
            return 'bad';
        };

        const alkClass = getStatus(last.alk, 8, 10);
        const caClass = getStatus(last.ca, 400, 450);
        const no3Class = getStatus(last.no3, 2, 10);

        statusDisplay.innerHTML = `
            <div class="status-box ${alkClass}">Alk: ${last.alk ?? '?'}</div>
            <div class="status-box ${caClass}">Ca: ${last.ca ?? '?'}</div>
            <div class="status-box ${no3Class}">NO3: ${last.no3 ?? '?'}</div>
        `;
    }

    function renderChart() {
        const labels = logs.map(l => l.date);
        
        // Define all datasets
        const datasets = [
            { label: 'Alk', data: logs.map(l => l.alk), borderColor: '#007bff', backgroundColor: '#007bff', spanGaps: true },
            { label: 'Ca',  data: logs.map(l => l.ca),  borderColor: '#6f42c1', backgroundColor: '#6f42c1', spanGaps: true },
            { label: 'Mg',  data: logs.map(l => l.mg),  borderColor: '#fd7e14', backgroundColor: '#fd7e14', spanGaps: true },
            { label: 'NO3', data: logs.map(l => l.no3), borderColor: '#28a745', backgroundColor: '#28a745', spanGaps: true },
            { label: 'PO4', data: logs.map(l => l.po4), borderColor: '#20c997', backgroundColor: '#20c997', spanGaps: true },
            { label: 'pH',  data: logs.map(l => l.ph),  borderColor: '#dc3545', backgroundColor: '#dc3545', spanGaps: true }
        ];

        // If chart exists, update data
        if (chartInstance) {
            chartInstance.data.labels = labels;
            datasets.forEach((ds, i) => {
                chartInstance.data.datasets[i].data = ds.data;
            });
            chartInstance.update();
            return;
        }

        // Initialize chart
        chartInstance = new Chart(tankCtx, {
            type: 'line',
            data: {
                labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { 
                    legend: { display: false } // Hide default legend since we have custom checkboxes
                },
                scales: { 
                    x: { display: true }, 
                    y: { display: true, beginAtZero: false } // Axis will auto-scale to visible data
                }
            }
        });

        // Set initial visibility based on checked boxes
        chartCheckboxes.forEach((cb, idx) => {
            chartInstance.data.datasets[idx].hidden = !cb.checked;
        });
        chartInstance.update();
    }

    // --- CALCULATOR LOGIC ---
    function calculateDosing() {
        const currentCa = toNum(calcCurrentCaInput.value);
        const targetCa = toNum(calcTargetCaInput.value);

        if (currentCa === null || targetCa === null) {
            alert("Please enter Current and Target Calcium.");
            return;
        }

        let dailyP1 = 0;
        let dailyDrop = 0;

        const caLogs = logs.filter(l => toNum(l.ca) !== null);
        if (caLogs.length >= 2) {
            const curL = caLogs[caLogs.length-1];
            const preL = caLogs[caLogs.length-2];
            const days = Math.abs((new Date(curL.date) - new Date(preL.date)) / (1000*60*60*24)) || 1;
            const caLoss = (preL.ca ?? 0) - (curL.ca ?? 0);
            dailyDrop = caLoss > 0 ? caLoss / days : 0;
            if (dailyDrop > 0) dailyP1 = dailyDrop / CA_IMPACT_FACTOR;
        }

        const dailyP2 = dailyP1 * RATIO_P2;
        const dailyP3 = dailyP1 * RATIO_P3;
        const dailyP4 = dailyP1 * RATIO_P4;

        const gap = targetCa - currentCa;
        let correctionP1_Daily = 0;
        let correctionMsg = "‚úÖ Levels match target.";

        if (gap > 5) {
            const totalCorrectionNeeded = gap / CA_IMPACT_FACTOR;
            if (gap > 20) {
                correctionP1_Daily = totalCorrectionNeeded / 3;
                correctionMsg = `‚ö†Ô∏è Low Calcium (-${gap} ppm). Adding correction dose over 3 days.`;
            } else {
                correctionP1_Daily = totalCorrectionNeeded;
                correctionMsg = `‚ö†Ô∏è Low Calcium (-${gap} ppm). Adding correction dose today.`;
            }
        }

        const totalP1Today = dailyP1 + correctionP1_Daily;

        calcResults.style.display = 'block';
        calcResults.innerHTML = `
            <h3>üß™ Red Sea Dosing Plan</h3>
            <p>Daily Consumption: <b>${dailyDrop.toFixed(1)} ppm/day</b></p>
            <table style="width:100%; border-collapse: collapse; text-align: center; border:1px solid #ddd;">
                <tr style="background:#f0f0f0; font-weight:bold;">
                    <td style="padding:8px;">Product</td>
                    <td style="padding:8px;">Base</td>
                    <td style="padding:8px; color:#d63384;">Corr.</td>
                    <td style="padding:8px; background:#e3f2fd;">TOTAL</td>
                </tr>
                <tr>
                    <td style="text-align:left; padding:8px;"><b>Part 1</b> (Ca)</td>
                    <td>${dailyP1.toFixed(1)}</td>
                    <td style="color:#d63384;">+ ${correctionP1_Daily.toFixed(1)}</td>
                    <td style="background:#e3f2fd; font-weight:bold;">${totalP1Today.toFixed(1)} mL</td>
                </tr>
                <tr>
                    <td style="text-align:left; padding:8px;"><b>Part 2</b> (Alk)</td>
                    <td>${dailyP2.toFixed(1)}</td>
                    <td>-</td>
                    <td style="background:#e3f2fd;">${dailyP2.toFixed(1)} mL</td>
                </tr>
                <tr>
                    <td style="text-align:left; padding:8px;"><b>Part 3</b> (Iodine)</td>
                    <td>${dailyP3.toFixed(1)}</td>
                    <td>-</td>
                    <td style="background:#e3f2fd;">${dailyP3.toFixed(1)} mL</td>
                </tr>
                <tr>
                    <td style="text-align:left; padding:8px;"><b>Part 4</b> (Bio)</td>
                    <td>${dailyP4.toFixed(1)}</td>
                    <td>-</td>
                    <td style="background:#e3f2fd;">${dailyP4.toFixed(1)} mL</td>
                </tr>
            </table>
            <p style="margin-top:10px; font-size:0.9em; color:#666;"><em>${correctionMsg}</em></p>
        `;
    }

    // Initial load
    loadData();
    </script>
</body>
</html>
