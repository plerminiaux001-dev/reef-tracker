<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reef Tank Dashboard & Dosing Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #f4f4f9; --card: #ffffff; --primary: #007bff; --text: #333; --active-tab: #0056b3; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 1000px; margin: 0 auto; }
        h1, h2, h3 { color: #2c3e50; margin-top: 0; }
        
        /* Grid Layouts */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .grid-small { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        
        /* Card Styling */
        .card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card.highlight { border-top: 5px solid var(--primary); }
        
        /* Tab Navigation Styles */
        .tab-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab-btn { background: #e9ecef; color: #555; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; transition: 0.3s; flex: 1; max-width: 200px; text-align: center; }
        .tab-btn:hover { background: #dcdcdc; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        /* Hide tab content by default */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Form Styles */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1em; width: 100%; }
        button:hover { background: #0056b3; }
        button.delete { background: #dc3545; margin-top: 10px; }

        /* Status Indicators */
        .status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .status-box { padding: 10px; border-radius: 5px; text-align: center; color: white; font-weight: bold; }
        .good { background: #28a745; }
        .warn { background: #ffc107; color: #333; }
        .bad { background: #dc3545; }

        /* Calculator Output */
        #calc-results { margin-top: 20px; padding: 15px; background: #e9ecef; border-left: 5px solid #007bff; display: none; }
        .calc-highlight { font-weight: bold; color: #d63384; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        
        /* Info Tables (Instructions Tab) */
        .info-table { width: 100%; border: 1px solid #eee; margin-bottom: 20px; font-size: 0.9em; }
        .info-table th { background: #007bff; color: white; text-align: center; }
        .info-table td { text-align: center; border-bottom: 1px solid #eee; }
        .info-table tr:last-child td { border-bottom: none; }

        /* Recipe Table */
        .recipe-table td { font-weight: bold; color: #555; }
        .recipe-table td:last-child { color: var(--primary); font-size: 1.1em; text-align: right; }
    </style>
</head>
<body>

    <h1>üê† 35g Reef Command Center</h1>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="openTab('dashboard')">Dashboard</button>
        <button class="tab-btn" onclick="openTab('instructions')">Dosing Instructions</button>
    </div>

    <div id="dashboard" class="tab-content active">
        <div class="card" style="margin-bottom: 20px;">
            <h2>Current Status</h2>
            <div class="status-grid" id="statusDisplay">
                <div class="status-box warn">No Data</div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üìù Add New Log</h2>
                <div class="form-group"><label>Date</label><input type="date" id="date"></div>
                <div class="form-group"><label>Alkalinity (dKH)</label><input type="number" step="0.1" id="alk"></div>
                <div class="form-group"><label>Calcium (ppm)</label><input type="number" id="ca"></div>
                <div class="form-group"><label>Magnesium (ppm)</label><input type="number" id="mg"></div>
                <div class="form-group"><label>Nitrate (ppm)</label><input type="number" step="0.1" id="no3"></div>
                <div class="form-group"><label>Phosphate (ppm)</label><input type="number" step="0.01" id="po4"></div>
                <div class="form-group"><label>pH</label><input type="number" step="0.1" id="ph"></div>
                <button onclick="addLog()">Save Entry</button>
            </div>

            <div class="card">
                <h2>üß™ Dosing Assistant</h2>
                <p>Calculate your daily Red Sea recipe based on Calcium uptake.</p>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                    <div class="form-group">
                        <label>Current Ca (ppm)</label>
                        <input type="number" id="calcCurrentCa" placeholder="...">
                    </div>
                    <div class="form-group">
                        <label>Target Ca (ppm)</label>
                        <input type="number" id="calcTargetCa" value="430">
                    </div>
                </div>

                <button onclick="calculateDosing()">Calculate Recipe</button>
                <div id="calc-results"></div>
            </div>
        </div>

        <div class="card">
            <h2>üìà Trends</h2>
            <canvas id="tankChart"></canvas>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h2>History</h2>
            <button class="delete" onclick="clearData()" style="width: auto; float: right; padding: 5px 10px;">Clear All Data</button>
            <table id="historyTable">
                <thead><tr><th>Date</th><th>Alk</th><th>Ca</th><th>Mg</th><th>NO3</th><th>PO4</th><th>pH</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="instructions" class="tab-content">
        <div class="card highlight">
            <h2>Red Sea Complete Reef Care</h2>
            <p>A 4-part program based on Calcium uptake. All 4 parts are dosed in a fixed ratio.</p>

            <h3>1. Recommended Parameters</h3>
            <table class="info-table">
                <thead>
                    <tr><th>Type</th><th>Salinity</th><th>Calcium</th><th>Alkalinity</th></tr>
                </thead>
                <tbody>
                    <tr><td>Mixed Reef</td><td>34 ppt</td><td>450 ppm</td><td>11.5 dKH</td></tr>
                    <tr><td>SPS Dominant</td><td>35 ppt</td><td>430 ppm</td><td>8.0 dKH</td></tr>
                    <tr><td>ULNS / Low Nutrients</td><td>33 ppt</td><td>410 ppm</td><td>7.0 dKH</td></tr>
                </tbody>
            </table>

            <h3>2. Dosing Ratios</h3>
            <p style="font-size:0.9em; color:#666;">The system uses Part 1 (Calcium) as the master dose. All other parts are calculated relative to it.</p>
            <table class="info-table">
                <thead>
                    <tr><th>Supplement</th><th>Ratio</th><th>Dose per 1mL of Part 1</th></tr>
                </thead>
                <tbody>
                    <tr><td><b>Part 1</b> (Ca & Mg)</td><td>1.0</td><td>1 mL</td></tr>
                    <tr><td><b>Part 2</b> (Alk & pH)</td><td>2.0</td><td>2 mL</td></tr>
                    <tr><td><b>Part 3</b> (Iodine & K)</td><td>0.5</td><td>0.5 mL</td></tr>
                    <tr><td><b>Part 4</b> (Iron & Bio)</td><td>0.5</td><td>0.5 mL</td></tr>
                </tbody>
            </table>

            <h3>3. Rules of Thumb</h3>
            <ul style="line-height:1.6; color:#444;">
                <li><b>Separation:</b> Wait at least 10 minutes between dosing each part.</li>
                <li><b>Order:</b> Always dose in numerical order (1 &rarr; 2 &rarr; 3 &rarr; 4).</li>
                <li><b>Max Daily Increase:</b> Do not raise Calcium by more than 20ppm or Alkalinity by more than 1.4 dKH per day.</li>
                <li><b>Adjustment:</b> If Calcium needs a large correction, calculate the total needed and divide by 3 to spread it over 3 days.</li>
            </ul>
        </div>
    </div>

<script>
    // --- TABS LOGIC ---
    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
        const btn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.getAttribute('onclick').includes(tabId));
        if(btn) btn.classList.add('active');
    }

    // --- CONFIGURATION ---
    const TANK_GAL = 35; 
    const TANK_LITERS = TANK_GAL * 3.78541; // ~132.5 Liters

    // IMPACT FACTOR (Based on Red Sea Manual)
    // 1ml of Part 1 raises 100 Liters by 1.4 ppm.
    const CA_IMPACT_PER_100L = 1.4; 
    const CA_IMPACT_FACTOR = CA_IMPACT_PER_100L * (100 / TANK_LITERS); 
    // Result: 1ml raises your 35g tank by ~1.056 ppm Ca

    // DOSING RATIOS (Based on Red Sea Manual)
    // Ratio is 1 : 2 : 0.5 : 0.5
    const RATIO_P2 = 2.0;
    const RATIO_P3 = 0.5;
    const RATIO_P4 = 0.5;

    // --- APP LOGIC ---
    let logs = JSON.parse(localStorage.getItem('reefLogs')) || [];
    const dateInput = document.getElementById('date');
    if(dateInput) dateInput.valueAsDate = new Date();

    function saveToStorage() {
        logs.sort((a, b) => new Date(a.date) - new Date(b.date));
        localStorage.setItem('reefLogs', JSON.stringify(logs));
        renderAll();
    }

    function addLog() {
        const entry = {
            date: document.getElementById('date').value,
            alk: parseFloat(document.getElementById('alk').value),
            ca: parseFloat(document.getElementById('ca').value),
            mg: parseFloat(document.getElementById('mg').value),
            no3: parseFloat(document.getElementById('no3').value),
            po4: parseFloat(document.getElementById('po4').value),
            ph: parseFloat(document.getElementById('ph').value)
        };

        if(!entry.date || !entry.alk) { alert("Date and Alkalinity are required!"); return; }
        
        logs.push(entry);
        saveToStorage();
        document.querySelectorAll('input[type=number]').forEach(i => i.value = '');
        document.getElementById('calcTargetCa').value = "430";
    }

    function clearData() {
        if(confirm("Are you sure you want to delete all history?")) {
            localStorage.removeItem('reefLogs');
            logs = [];
            renderAll();
        }
    }

    // --- VISUALIZATION ---
    let chartInstance = null;

    function renderAll() {
        renderTable();
        renderStatus();
        renderChart();
        if(logs.length > 0) {
            const last = logs[logs.length - 1];
            if(last.ca) document.getElementById('calcCurrentCa').value = last.ca;
        }
    }

    function renderTable() {
        const tbody = document.querySelector('#historyTable tbody');
        if(!tbody) return;
        tbody.innerHTML = '';
        [...logs].reverse().forEach(log => {
            const row = `<tr>
                <td>${log.date}</td>
                <td>${log.alk}</td>
                <td>${log.ca}</td>
                <td>${log.mg}</td>
                <td>${log.no3}</td>
                <td>${log.po4}</td>
                <td>${log.ph}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function renderStatus() {
        if (logs.length === 0) return;
        const last = logs[logs.length - 1];
        const display = document.getElementById('statusDisplay');
        function getStatus(val, min, max) { return (val >= min && val <= max) ? 'good' : 'bad'; }

        display.innerHTML = `
            <div class="status-box ${getStatus(last.alk, 8, 10)}">Alk: ${last.alk}</div>
            <div class="status-box ${getStatus(last.ca, 400, 450)}">Ca: ${last.ca}</div>
            <div class="status-box ${getStatus(last.no3, 2, 10)}">NO3: ${last.no3}</div>
        `;
    }

    function renderChart() {
        const ctx = document.getElementById('tankChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: logs.map(l => l.date),
                datasets: [
                    { label: 'Alk (dKH)', data: logs.map(l => l.alk), borderColor: '#007bff', tension: 0.1 },
                    { label: 'Calcium (ppm)', data: logs.map(l => l.ca), borderColor: '#6f42c1', tension: 0.1 },
                    { label: 'Nitrate (ppm)', data: logs.map(l => l.no3), borderColor: '#28a745', tension: 0.1 }
                ]
            }
        });
    }

    // --- HELPERS ---
    function generateRecipeHTML(baseP1) {
        const p2 = baseP1 * RATIO_P2;
        const p3 = baseP1 * RATIO_P3;
        const p4 = baseP1 * RATIO_P4;
        
        return `
            <table class="recipe-table" style="background:white; border-radius:5px; border:1px solid #eee;">
                <tr><td>Part 1 (Ca/Mg)</td><td>${baseP1.toFixed(1)} mL</td></tr>
                <tr><td>Part 2 (Alk)</td><td>${p2.toFixed(1)} mL</td></tr>
                <tr><td>Part 3 (Iodine)</td><td>${p3.toFixed(1)} mL</td></tr>
                <tr><td>Part 4 (Bioactive)</td><td>${p4.toFixed(1)} mL</td></tr>
            </table>
        `;
    }

    // --- DOSING CALCULATOR LOGIC ---
// --- UPDATED DOSING CALCULATOR (Red Sea Style) ---
    function calculateDosing() {
        if (logs.length < 2) {
            alert("Need at least 2 log entries to calculate trends!");
            return;
        }

        const current = logs[logs.length - 1];
        const previous = logs[logs.length - 2];
        const daysDiff = (new Date(current.date) - new Date(previous.date)) / (1000 * 60 * 60 * 24);
        
        if (daysDiff === 0) { alert("Entries are on the same day. Cannot calc usage."); return; }

        // --- 1. CALCULATE DAILY CONSUMPTION (The "Base") ---
        // How much did the tank drop per day?
        // Note: This assumes you DID NOT dose anything between tests. 
        // If you did dose, this logic needs your total dosed amount to be perfect.
        // For now, we estimate raw drop.
        
        const caDropPerDay = (previous.ca - current.ca) / daysDiff; 
        // Heuristic: 1ml of Red Sea Part 1 raises ~2ppm in 25g (Approximation)
        // Adjust for 35g: 1ml raises ~1.4ppm.
        const part1DailyMaint = caDropPerDay > 0 ? (caDropPerDay / 1.4).toFixed(1) : 0; 

        // Red Sea Ratio for Parts 2, 3, 4 based on Part 1
        const part2Daily = (part1DailyMaint * 2).toFixed(1); // Usually 2x Part 1 volume
        const part3Daily = (part1DailyMaint * 0.5).toFixed(1); // Usually 0.5x Part 1 volume
        const part4Daily = (part1DailyMaint * 0.5).toFixed(1); // Usually 0.5x Part 1 volume

        // --- 2. CALCULATE CORRECTION (The "Fix") ---
        // Target Calcium: 430 ppm
        const targetCa = 430;
        const caDeficit = targetCa - current.ca;
        
        let correctionMsg = "No correction needed.";
        let part1Correction = 0;
        
        if (caDeficit > 10) {
            // Need to raise Ca.
            // Total mL needed = Deficit / 1.4 (ppm per mL in 35g)
            const totalNeeded = caDeficit / 1.4;
            // Split over 3 days max safety
            part1Correction = (totalNeeded / 3).toFixed(1);
            correctionMsg = `Calcium is low (${current.ca}). Raise to ${targetCa} over 3 days.`;
        }

        // --- 3. RENDER THE SPLIT TABLE ---
        const totalPart1 = (parseFloat(part1DailyMaint) + parseFloat(part1Correction)).toFixed(1);

        const resDiv = document.getElementById('calc-results');
        resDiv.style.display = 'block';
        resDiv.innerHTML = `
            <h3>üß™ Red Sea Dosing Plan</h3>
            <p>Based on a drop of <b>${caDropPerDay.toFixed(1)} ppm Calcium/day</b></p>
            
            <table style="width:100%; border-collapse: collapse; text-align: center;">
                <tr style="background:#f0f0f0; font-weight:bold;">
                    <td style="padding:8px; border:1px solid #ddd;">Product</td>
                    <td style="padding:8px; border:1px solid #ddd;">Daily Base<br><span style="font-size:0.8em; font-weight:normal">(Forever)</span></td>
                    <td style="padding:8px; border:1px solid #ddd; color:#d63384;">Correction<br><span style="font-size:0.8em; font-weight:normal">(3 Days Only)</span></td>
                    <td style="padding:8px; border:1px solid #ddd; background:#e3f2fd;">TOTAL TODAY</td>
                </tr>
                <tr>
                    <td style="text-align:left; padding:8px; border:1px solid #ddd;"><b>Part 1</b> (Ca)</td>
                    <td style="border:1px solid #ddd;">${part1DailyMaint} mL</td>
                    <td style="border:1px solid #ddd; color:#d63384; font-weight:bold;">+ ${part1Correction} mL</td>
                    <td style="border:1px solid #ddd; background:#e3f2fd; font-weight:bold;">${totalPart1} mL</td>
                </tr>
                <tr>
                    <td style="text-align:left; padding:8px; border:1px solid #ddd;"><b>Part 2</b> (Alk)</td>
                    <td style="border:1px solid #ddd;">${part2Daily} mL</td>
                    <td style="border:1px solid #ddd; color:#ccc;">-</td>
                    <td style="border:1px solid #ddd; background:#e3f2fd;">${part2Daily} mL</td>
                </tr>
                <tr>
                    <td style="text-align:left; padding:8px; border:1px solid #ddd;"><b>Part 3</b> (Iodine)</td>
                    <td style="border:1px solid #ddd;">${part3Daily} mL</td>
                    <td style="border:1px solid #ddd; color:#ccc;">-</td>
                    <td style="border:1px solid #ddd; background:#e3f2fd;">${part3Daily} mL</td>
                </tr>
                <tr>
                    <td style="text-align:left; padding:8px; border:1px solid #ddd;"><b>Part 4</b> (Bio)</td>
                    <td style="border:1px solid #ddd;">${part4Daily} mL</td>
                    <td style="border:1px solid #ddd; color:#ccc;">-</td>
                    <td style="border:1px solid #ddd; background:#e3f2fd;">${part4Daily} mL</td>
                </tr>
            </table>
            <p style="margin-top:10px; font-size:0.9em;"><em>${correctionMsg}</em></p>
        `;
    }
            // MANUAL FALLBACK FOR NO DATA
            planHTML = `
                <h3>New Daily Schedule</h3>
                <p style="color:#d63384; font-size:0.9em;">‚ö†Ô∏è Need 2 logs to calculate consumption.</p>
                <div style="background:#fff3cd; padding:10px; border-radius:5px;">
                    <p style="margin:0 0 5px 0; font-size:0.9em;"><b>Estimate Recipe Manually:</b></p>
                    <input type="number" id="manualBase" placeholder="Enter planned Part 1 dose (mL)" style="margin-bottom:5px;">
                    <button onclick="renderManualRecipe()" style="padding:5px; font-size:0.9em;">Show Ratios</button>
                    <div id="manual-recipe-output" style="margin-top:10px;"></div>
                </div>
            `;
        }

        const resDiv = document.getElementById('calc-results');
        resDiv.style.display = 'block';
        resDiv.innerHTML = `
            ${planHTML}
            <hr>
            <p>${correctionMsg}</p>
        `;
    }

    function renderManualRecipe() {
        const val = parseFloat(document.getElementById('manualBase').value);
        if(val) {
            document.getElementById('manual-recipe-output').innerHTML = generateRecipeHTML(val);
        }
    }

    renderAll();
</script>
</body>
</html>
